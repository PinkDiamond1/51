<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.0/normalize.min.css">
<link rel="stylesheet" href="51.css">
</head>
<body>
<did id="divBGHeader"></did>
<did id="divBGBillboard"></did>  
<div id="divHeader">
  <div id="divMenuItems">
     <a href='index.html'>51 Bank</a><a href='console.html'>Console</a><a href='dashboard.html'>Dashboard</a><a id="hldMenuItem" href='docs.html'>Docs</a></div>
  <div id="divBillboard"></div>
</div>
<div id="divMain">
  <h1>Test</h1>
  <div>A simple page to load up data into the system</div>

  <button id="btnCreate10Customers" onclick="create10Customers()">Create 10 customers</button>
  <button onclick="createAccountsForCustomers()">Create Accounts</button>
</div>

<script src='libs/createParseCurl.js'></script>
<script src='libs/createRestEngine.js'></script>
<script src='libs/createBillboard.js'></script>
<script src='libs/createSTPEngine.js'></script>
<script src='libs/createMonitoringTable.js'></script>
<script>
const parseCurl = createParseCurl();

const bank = {
  customers : [],
  accounts : [],
  payments : []
};


const restEngine = createRestEngine({bank, parseCurl}); 


async function pause(time) {
  return new Promise((res) => setTimeout(res, time));
};

(async function syncUpToTheLocalStorage() { // syncs up with the localStorage
  const loader = restEngine.getLSLoader();   // if there are not too many instructions it just reads them as fast as it can
  if (loader.length < 101) {                 // otherwise it creates a divProgressBar to track the synch-ing exercise.
    for (let i=0;i<loader.length;i++) {
      await loader.next(); 
    }
  } else {
    async function pause(time) { return new Promise((res) => setTimeout(res, time)); };
    const divProgressBar = document.createElement('div');
    divProgressBar.style.position = 'absolute';
    divProgressBar.style.top = '80px';
    divProgressBar.style.left = 0; 
    divProgressBar.style.height = '2px';
    divProgressBar.style.background = 'black';
    document.body.appendChild(divProgressBar); 
    for (let i=0;i<loader.length;i++) {
      await loader.next(); 
      await pause(0); // encourages the UI thread to yield.  (change the value of pause(500) to test behaviour on slow loading)
      divProgressBar.style.width = ((i+1) * 100) /loader.length + '%';
    }
    document.body.removeChild(divProgressBar); 
  }

  divBillboard.appendChild(createBillboard({
    bank
  })); 

  createSTPEngine({bank, parseCurl, restEngine});

})(); 

async function create10Customers() {

  let unique = Math.floor(Math.random()*10000000000).toString(36); 

  for (let i=0;i<10;i++) {
    const s = "curl https://api.51bank.io/customers -Xpost "+
              "-dfirstName=Alice "+
              "-dlastName=McCartney "+
              "-demail="+unique+'.'+i+"@gmail.com " + 
              "-dnationality=GB " + 
              "-ddateOfBirth=\"1985-08-23\" " +
              "-daddress=\"/GB/220 cleveland road/london/w13 9pn\""; 
    console.log(s); 
  
    const request = parseCurl(s); 
    const result = await restEngine.executeRequest(request);
    console.log(result); 
  }
}


async function createAccountsForCustomers() {
  let x = 0; 
  for (let customer of bank.customers) {
    const e = bank.accounts.find(account => account.customerId === customer.id);
    if (e == null) {
      const s = "curl https://api.51bank.io/accounts -Xpost "+
                "-dcustomerId="+customer.id+" -dtype=personal"; 
      const request = parseCurl(s); 
      const result = await restEngine.executeRequest(request);
      console.log(result);           
      x++;
    }
  }
  console.log("created accounts total "+x);
  
}


</script>
</body>
</html>

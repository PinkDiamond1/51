<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.0/normalize.min.css">
<link rel="stylesheet" href="51.css">
</head>
<body>
<did id="divBGHeader"></did>
<did id="divBGBillboard"></did>
<div id="divHeader">
  <div id="divMenuItems">
    <a href='index.html'>51 Bank</a><a href='console.html'>Console</a><a href='dashboard.html'>Dashboard</a><a id="hldMenuItem" href='docs.html'>Docs</a></div>
  <div id="divBillboard"></div>
</div>
<div id="divMain">
<h1>Statistics</h1>
<div>The system is currently configured to use the local storage to save its data.</div>
<div id="divNoStats" style="display:none">âš  There are no statistics available at the moment. Please try to enter some data before coming back here</div>

<ul>
  <li>
<div>The system was created 3 days ago on Monday the 6/July/2022</div>
</li>
<li>
<div>The system has processed 23 instructions so far</div>
</li>
<li>
<div>The storage usage is 7.32Kb - 0.14% of the available storage space</div>
</li>
</ul>


<div><canvas id='cnvChart'></canvas></div>
<div id="divUsedStorage"></div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.8.0/dist/chart.min.js"></script>
<script>


if (localStorage.length <= 1) {
  divNoStats.style.display = 'block';
}


function createChart(config) {
  console.log(config);
  const { labels, genInstructions, payInstructions, boldIndex } = config; 
  const data = {
    labels,
    datasets : [ { label : 'General Instructions', data: genInstructions, backgroundColor: 'dodgerBlue' },
                 { label : 'Payment Instructions', data: payInstructions, backgroundColor: 'blue' }]
  };
  
  new Chart( document.getElementById('cnvChart').getContext('2d'), {
    type: 'bar',
    data, 
    options : {
      responsive : true,
      scales: {
        x: {
          stacked: true,
          ticks : {
            autoSkip : false, // enable labels no matter how small the chart is
            maxRotation: 0,
            minRotation: 0, 
            font: (v) => { if (v.index === boldIndex ) return { weight: 'bold' }}

          }
        },
        y: {
          stacked : true,
          ticks : {
            precision:0 // to disallow fractional values e.g 1.5 in the Y axis
          }
        }
      }
    }
  });    
}

function createOneWeekConfig(messages, today) {
  const labels = [ 'Sun','Mon','Tue','Wed','Thu','Fri','Sat' ];
  const genInstructions = [0,0,0,0,0,0,0];
  const payInstructions = [0,0,0,0,0,0,0];
  for (let i=0;i<messages.length;i++) {
    const { timestamp, text} = messages[i];
    const index = new Date(timestamp).getDay();
    if (text.indexOf('api.51bank.io/payments')!==-1) payInstructions[index]++;
    else                                             genInstructions[index]++;
  }
  return {
    labels,
    genInstructions,
    payInstructions,
    boldIndex : today.getDay()
  };
}


{ // FOR NOW WE GO DIRECTLY TO THE LOCAL STORAGE.
  // NEED TO THINK HOW BEST TO EXPOSE THE MESSAGES From the RESTENGINE.
  // ALSO WHILE RELOADING THE LOCAL STORAGE !!!
  const messages = []; 
  for (let i=0;i<localStorage.length-1; i++) {
    messages.push( JSON.parse(localStorage.getItem(i)) );
  }

  createChart(createOneWeekConfig(messages,new Date()));

  function computeStorageInBytes() {
    let count = 0; 
    for (const i in localStorage) {
      if (!localStorage.hasOwnProperty(i)) continue;
      count+= localStorage[i].length + i.length;
    }
    return count; 
  };

  const size = computeStorageInBytes();
   divUsedStorage.innerHTML = 'Used Storage: '+ (size/1024).toFixed(2)+'KB - ' +  (size*100/(5*1024*1024)).toFixed(2)+'%';

}
</script>
</body>
</html>
